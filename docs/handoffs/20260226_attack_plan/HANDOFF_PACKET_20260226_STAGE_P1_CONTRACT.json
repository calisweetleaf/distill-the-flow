{
  "run_id": "moonshine_attack_plan_20260226",
  "stage_id": "stage_p1_schema_gate_contract_v1",
  "role": "planner_reasoner",
  "state_hash_in": "p0_locked:scope_owners_handoff_protocol",
  "state_hash_out": "p1_locked:schema_gate_execution_contract",
  "files_changed": [
    "docs/handoffs/20260226_attack_plan/HANDOFF_PACKET_20260226_STAGE_P1_CONTRACT.json"
  ],
  "verification": {
    "checks": [
      "Required provider schema fields explicitly defined",
      "Merge-key deterministic record_uid contract explicitly defined",
      "Provider-local directory and artifact contract explicitly defined",
      "Main-lane snapshot-before-merge rule explicitly defined",
      "Gate checklist and evidence expectations explicitly defined",
      "OpenCode builder task list and Claude finisher task list explicitly defined"
    ],
    "status": "pass",
    "evidence": [
      "P1 contract includes table-level field requirements",
      "P1 contract includes acceptance gates G1-G8",
      "P1 contract includes builder and finisher stage responsibilities"
    ]
  },
  "result": {
    "summary": "Schema and operational gate contract is now fixed for OpenCode implementation and Claude finishing.",
    "artifacts": [
      "docs/handoffs/20260226_attack_plan/HANDOFF_PACKET_20260226_STAGE_P1_CONTRACT.json"
    ],
    "risks": [
      "Existing main DB may fail parity until migration path is implemented",
      "Legacy docs may conflict with new provider schema unless finisher harmonizes wording",
      "Merge manifests can be non-authoritative if inserted/updated/skipped counters remain null"
    ],
    "execution_contract": {
      "schema_requirements": {
        "tables": [
          "conversations",
          "messages",
          "distilled_conversations"
        ],
        "required_fields": [
          "provider",
          "provider_run_id",
          "source_file_sha256",
          "source_path",
          "ingested_at",
          "record_uid"
        ],
        "messages_additional_required_fields": [
          "conversation_record_uid"
        ],
        "record_uid_rules": {
          "conversations": "provider:provider_run_id:conversation_id",
          "messages": "provider:provider_run_id:conversation_id:message_id",
          "distilled_conversations": "provider:provider_run_id:conversation_id"
        }
      },
      "provider_run_contract": {
        "path_pattern": "reports/providers/<provider>/<run_id>/",
        "required_artifacts": [
          "moonshine_<provider>_<run_id>.db",
          "token_ledger.<provider>.<run_id>.json",
          "moonshine_corpus_report.<provider>.<run_id>.md",
          "moonshine_distillation_manifest.<provider>.<run_id>.json",
          "visualizations_manifest.<provider>.<run_id>.json"
        ]
      },
      "main_merge_contract": {
        "active_db": "reports/main/moonshine_mash_active.db",
        "snapshot_before_merge": "archive/main/<run_id>/moonshine_mash_premerge.db",
        "merge_manifest": "reports/main/merge_manifest.main.json",
        "required_merge_counters": [
          "inserted",
          "updated",
          "skipped"
        ],
        "idempotence_rule": "second identical merge run yields zero net new records"
      },
      "gate_checklist": [
        "G1 schema parity on required fields",
        "G2 provider coverage = 100% on merged rows",
        "G3 record_uid uniqueness preserved",
        "G4 snapshot-before-merge evidence present",
        "G5 merge counters populated (non-null)",
        "G6 idempotence re-run check passes",
        "G7 token reconciliation report emitted",
        "G8 docs synchronized to new run state"
      ],
      "builder_executor_open_code": {
        "owned_outputs": [
          "code changes implementing schema + migration + merge enforcement",
          "B1 handoff packet with changed files and command verification summary"
        ],
        "must_emit_signal": "forward or revision_request"
      },
      "finisher_polisher_claude": {
        "owned_outputs": [
          "regression and docs harmonization",
          "F1 handoff packet with final risk posture and release readiness"
        ],
        "must_reconcile": [
          "claim-vs-artifact drift",
          "schema-vs-doc mismatch",
          "residual caveat language"
        ]
      }
    }
  },
  "next_actions": [
    "Hand this P1 packet to OpenCode as the authoritative build contract",
    "Require B1 implementation output and packet in the same directory",
    "Run C1 adjudication against G1-G8 gates",
    "Only then hand to Claude F1 finisher"
  ],
  "signal_type": "forward",
  "coverage": {
    "selected_tools": [
      "bb7_exo_bootstrap",
      "bb7_exo_list_tool_categories",
      "bb7_exo_category_specific_tools",
      "bb7_memory_intelligent_search",
      "bb7_exo_route",
      "bb7_exo_plan",
      "bb7_write_file"
    ],
    "unused_categories": [
      "web",
      "visual"
    ],
    "rationale": "P1 is a schema and execution contract definition stage intended for downstream builder/finisher implementation."
  }
}
